<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas de Diseño - ArelyShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Estilos Medidas */
        #canvas-container {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            border: 3px dashed #cbd5e1; /* slate-300 */
            transition: border-color 0.3s, background-color 0.3s;
        }
        #canvas-container.drag-over, #precios-previews-container.drag-over {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        canvas { display: block; width: 100%; height: 100%; }
        .color-swatch {
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: border-color 0.2s;
        }
        .color-swatch.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px white; }
        #modal { background-color: rgba(0, 0, 0, 0.5); }
        
        /* Estilos Pestañas y Herramientas */
        .tool-tab { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .tool-tab.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .tool-btn { transition: background-color 0.2s, color 0.2s; }
        .tool-btn.active { background-color: #3b82f6; color: white; }

        /* Estilos Collage */
        .collage-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 0.75rem; /* gap-3 */
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
        }
        .collage-cell {
            background-color: #e2e8f0; /* slate-200 */
            border: 2px dashed #94a3b8; /* slate-400 */
            border-radius: 0.5rem; /* rounded-lg */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .collage-cell .placeholder {
            color: #64748b; /* slate-500 */
            text-align: center;
            pointer-events: none;
        }
        .collage-cell.has-image .placeholder { display: none; }
        .collage-cell.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .collage-cell.drag-over-target {
            border-style: solid;
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        .delete-cell-btn {
            position: absolute;
            top: 0.5rem; right: 0.5rem; width: 2rem; height: 2rem;
            background-color: rgba(239, 68, 68, 0.8);
            color: white; border: none; border-radius: 50%;
            font-size: 1.5rem; line-height: 2rem; text-align: center;
            cursor: pointer; transition: background-color 0.2s, transform 0.2s;
            z-index: 10; display: none;
        }
        .collage-cell.has-image .delete-cell-btn { display: block; }
        .delete-cell-btn:hover { background-color: #dc2626; transform: scale(1.1); }

        /* Estilos Precios */
         #precios-previews-container.is-placeholder {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            border: 3px dashed #cbd5e1;
            background-color: #fff;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #precios-previews-container {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .price-preview-wrapper {
            aspect-ratio: 1 / 1;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative; /* Para posicionar el botón de descarga */
        }
        .download-single-price-btn {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            background-color: rgba(16, 185, 129, 0.8); /* emerald-500 con opacidad */
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            z-index: 10;
        }
        .download-single-price-btn:hover {
            background-color: #059669; /* emerald-600 */
            transform: scale(1.1);
        }

        /* Estilos Mapas */
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        .map-tab {
            background-color: #f3f4f6; /* light-gray */
            color: #4b5563; /* gray-600 */
            border-color: transparent;
        }
        .map-tab.active {
            background-color: #e0e7ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
            border-color: #4338ca;
        }
        .map-tab-content {
            display: none;
        }
        .map-tab-content.active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 p-4 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-center">
            <img src="https://dcdn-us.mitiendanube.com/stores/004/546/736/themes/common/logo-660776128-1736645739-9bb5db1715d3b799cdf782b0f0815d541736645739.webp?0" alt="Logo ArelyShop" class="h-12" onerror="this.onerror=null; this.src='https://placehold.co/200x50/0f172a/ffffff?text=ArelyShop';">
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="flex-grow container mx-auto p-4 md:p-8 flex flex-col items-center">
        
        <!-- Pestañas de Herramientas -->
        <div class="w-full max-w-5xl mb-8">
            <div class="flex border-b border-slate-300">
                <button id="tab-medidas" class="tool-tab active -mb-px py-2 px-4 font-semibold text-slate-600 border-b-2 border-transparent rounded-t-lg">Medidas</button>
                <button id="tab-collage" class="tool-tab py-2 px-4 font-semibold text-slate-600 border-b-2 border-transparent rounded-t-lg">Collage</button>
                <button id="tab-precios" class="tool-tab py-2 px-4 font-semibold text-slate-600 border-b-2 border-transparent rounded-t-lg">Precios</button>
                <button id="tab-mapas" class="tool-tab py-2 px-4 font-semibold text-slate-600 border-b-2 border-transparent rounded-t-lg">Mapas</button>
            </div>
        </div>

        <!-- Contenedor Herramienta de Medidas -->
        <div id="medidas-tool" class="w-full">
            <div class="w-full max-w-5xl flex flex-col lg:flex-row gap-8 mx-auto">
                <div class="w-full lg:w-1/3 space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">1. Cargar Imagen</h2>
                        <label for="image-loader" class="w-full inline-block text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">Seleccionar Foto</label>
                        <input type="file" id="image-loader" class="hidden" accept="image/*">
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">2. Herramientas</h2>
                        <div class="flex rounded-md shadow-sm">
                            <button id="tool-measure" class="tool-btn active w-1/2 p-2 border border-slate-300 rounded-l-lg">Medir</button>
                            <button id="tool-brush" class="tool-btn w-1/2 p-2 border-t border-b border-r border-slate-300 rounded-r-lg">Pincel</button>
                        </div>
                    </div>
                    <div id="measure-controls" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h3 class="text-lg font-semibold text-slate-700">Color de Medida</h3>
                        <div id="color-palette" class="flex justify-center gap-4">
                            <div class="color-swatch selected" style="background-color: #000000;" data-color="#000000"></div>
                            <div class="color-swatch" style="background-color: #ef4444;" data-color="#ef4444"></div>
                            <div class="color-swatch" style="background-color: #3b82f6;" data-color="#3b82f6"></div>
                            <div class="color-swatch" style="background-color: #22c55e;" data-color="#22c55e"></div>
                            <div class="color-swatch" style="background-color: #f97316;" data-color="#f97316"></div>
                        </div>
                    </div>
                    <div id="brush-controls" class="bg-white p-6 rounded-lg shadow-md space-y-4 hidden">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700 mb-2">Color de Pincel</h3>
                            <input type="color" id="brush-color-picker" value="#FFFFFF" class="w-full h-10 p-1 border border-slate-300 rounded-md cursor-pointer">
                        </div>
                        <div>
                            <label for="brush-size-slider" class="text-lg font-semibold text-slate-700">Tamaño: <span id="brush-size-value">20</span>px</label>
                            <input type="range" id="brush-size-slider" min="1" max="100" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">3. Acciones</h2>
                        <div class="space-y-4">
                            <button id="download-btn" class="w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Descargar Imagen</button>
                            <button id="reset-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Limpiar Todo</button>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-2/3 flex flex-col items-center">
                    <div id="canvas-container" class="bg-white rounded-lg shadow-md flex items-center justify-center relative">
                        <canvas id="canvas" width="1000" height="1000"></canvas>
                        <div id="placeholder-text" class="absolute text-center text-slate-400 p-4 flex flex-col items-center gap-2">
                            <p class="text-lg font-semibold pointer-events-none">Arrastra y suelta una imagen aquí</p>
                            <span class="text-sm pointer-events-none">o</span>
                            <label for="image-loader" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">Cargar Foto</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor Herramienta de Collage -->
        <div id="collage-tool" class="w-full hidden">
             <div class="w-full max-w-5xl flex flex-col lg:flex-row gap-8 mx-auto">
                <div class="w-full lg:w-1/3 space-y-6">
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">1. Cargar Imágenes</h2>
                        <p class="text-slate-600 mb-4">Haz clic en un cuadro o arrastra una imagen. Para cargar varias, usa el botón.</p>
                        <button id="load-multiple-collage-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Cargar Varias Fotos</button>
                        <input type="file" id="collage-image-loader" class="hidden" accept="image/*">
                        <input type="file" id="collage-multiple-loader" class="hidden" accept="image/*" multiple>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">2. Acciones</h2>
                        <div class="space-y-4">
                            <button id="download-collage-btn" class="w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition">Descargar Collage</button>
                            <button id="clear-collage-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Limpiar Todo</button>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-2/3 flex flex-col items-center">
                    <div class="collage-grid">
                        <div id="cell-0" class="collage-cell" draggable="true"><div class="placeholder"><span>+</span><p>Imagen 1</p></div><button class="delete-cell-btn">&times;</button></div>
                        <div id="cell-1" class="collage-cell" draggable="true"><div class="placeholder"><span>+</span><p>Imagen 2</p></div><button class="delete-cell-btn">&times;</button></div>
                        <div id="cell-2" class="collage-cell" draggable="true"><div class="placeholder"><span>+</span><p>Imagen 3</p></div><button class="delete-cell-btn">&times;</button></div>
                        <div id="cell-3" class="collage-cell" draggable="true"><div class="placeholder"><span>+</span><p>Imagen 4</p></div><button class="delete-cell-btn">&times;</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor Herramienta de Precios -->
        <div id="precios-tool" class="w-full hidden">
             <div class="w-full max-w-5xl flex flex-col lg:flex-row gap-8 mx-auto">
                <!-- Columna de Controles (Precios) -->
                <div class="w-full lg:w-1/3 space-y-6">
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">1. Cargar Imagen(es)</h2>
                        <label for="precios-image-loader" class="w-full inline-block text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">Seleccionar Foto(s)</label>
                        <input type="file" id="precios-image-loader" class="hidden" accept="image/*" multiple>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">2. Información (para todas las fotos)</h2>
                        <div>
                            <label for="price-input" class="flex items-center text-sm font-medium text-slate-700 mb-1">
                                <i class="fa-solid fa-tag mr-2"></i>Precio
                            </label>
                            <div class="relative">
                                <span class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">Bs.</span>
                                <input type="text" id="price-input" class="w-full border border-slate-300 rounded-md p-2 pl-10" placeholder="150">
                            </div>
                        </div>
                        <div>
                            <label for="watermark-input" class="block text-sm font-medium text-slate-700 mb-1">Marca de Agua (Tienda)</label>
                            <input type="text" id="watermark-input" class="w-full border border-slate-300 rounded-md p-2" value="ArelyShop">
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">3. Acciones</h2>
                        <div class="space-y-4">
                            <button id="download-price-btn" class="w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Descargar Todo</button>
                            <button id="clear-price-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Limpiar Todo</button>
                        </div>
                    </div>
                </div>
                <!-- Columna del Canvas (Precios) -->
                <div class="w-full lg:w-2/3 flex flex-col items-center">
                    <div id="precios-previews-container" class="is-placeholder">
                        <div id="precios-placeholder-text" class="w-full text-center text-slate-400 p-4 flex flex-col items-center gap-2">
                            <p class="text-lg font-semibold pointer-events-none">Sube una o más imágenes para empezar</p>
                             <span class="text-sm pointer-events-none">o</span>
                            <label for="precios-image-loader" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">
                                Cargar Foto(s)
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor Herramienta de Mapas -->
        <div id="mapas-tool" class="w-full hidden">
            <div class="w-full max-w-lg mx-auto p-6 sm:p-8 bg-white rounded-xl shadow-lg space-y-6 relative overflow-hidden">
                <div class="text-center">
                    <h1 class="text-2xl font-bold text-gray-800">Conversor Universal de Mapas</h1>
                    <p class="text-gray-500 mt-2">Pega un enlace, introduce coordenadas o busca un lugar para convertir.</p>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button id="map-tab-url" class="map-tab active flex-1 py-2 px-4 text-center font-medium border-b-2 transition-colors duration-200">Desde URL</button>
                    <button id="map-tab-coords" class="map-tab flex-1 py-2 px-4 text-center font-medium border-b-2 transition-colors duration-200">Desde Coordenadas</button>
                </div>

                <!-- Input Forms -->
                <div class="space-y-4">
                    <!-- URL Input -->
                    <div id="map-content-url" class="map-tab-content active">
                        <label for="googleMapsUrl" class="block text-sm font-medium text-gray-700 mb-1">Enlace de Google Maps</label>
                         <div class="flex gap-2">
                            <input type="url" id="googleMapsUrl" placeholder="https://maps.app.goo.gl/..." class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button id="map-paste-url" class="bg-gray-200 text-gray-600 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-colors duration-200">Pegar</button>
                        </div>
                    </div>
                    <!-- Coordinates Input -->
                    <div id="map-content-coords" class="map-tab-content">
                        <label for="coordsInput" class="block text-sm font-medium text-gray-700 mb-1">Coordenadas (Decimal o GMS)</label>
                        <div class="flex gap-2">
                            <input type="text" id="coordsInput" placeholder="Ej: 17°45'40.1&quot;S 63°10'13.1&quot;W" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button id="map-paste-coords" class="bg-gray-200 text-gray-600 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-colors duration-200">Pegar</button>
                        </div>
                    </div>

                    <button id="map-getDirectionBtn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-colors duration-200">
                        Obtener ubicación
                    </button>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-sm">O</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <!-- Search Bar -->
                <div class="space-y-2">
                    <label for="map-searchInput" class="block text-sm font-medium text-gray-700">Buscar un Lugar</label>
                    <div class="flex gap-2">
                        <input type="text" id="map-searchInput" placeholder="Ej: Plaza 24 de Septiembre, Santa Cruz" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button id="map-searchBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-colors duration-200 flex items-center justify-center w-24">
                            <span class="search-text">Buscar</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="map-results" class="pt-4 space-y-3"></div>

                <!-- Error Message Box -->
                <div id="map-error-message" class="hidden p-4 bg-red-100 text-red-700 rounded-md">
                    <p id="map-error-text"></p>
                </div>

                <!-- Notification for 'Copied' -->
                <div id="notification" class="absolute bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-10">
                    ¡Copiado!
                </div>
            </div>
        </div>

    </main>

    <!-- Modal para medida -->
    <div id="modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-lg font-bold mb-4">Ingresar Medida</h3>
            <input type="text" id="measurement-input" class="w-full border border-slate-300 rounded-md p-2 mb-4" placeholder="Ej: 25 cm">
            <div class="flex justify-end gap-2">
                <button id="cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancelar</button>
                <button id="submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- PESTAÑAS ---
        const tabMedidas = document.getElementById('tab-medidas');
        const tabCollage = document.getElementById('tab-collage');
        const tabPrecios = document.getElementById('tab-precios');
        const tabMapas = document.getElementById('tab-mapas');
        const medidasTool = document.getElementById('medidas-tool');
        const collageTool = document.getElementById('collage-tool');
        const preciosTool = document.getElementById('precios-tool');
        const mapasTool = document.getElementById('mapas-tool');

        tabMedidas.addEventListener('click', () => {
            medidasTool.classList.remove('hidden');
            collageTool.classList.add('hidden');
            preciosTool.classList.add('hidden');
            mapasTool.classList.add('hidden');
            tabMedidas.classList.add('active');
            tabCollage.classList.remove('active');
            tabPrecios.classList.remove('active');
            tabMapas.classList.remove('active');
        });

        tabCollage.addEventListener('click', () => {
            medidasTool.classList.add('hidden');
            collageTool.classList.remove('hidden');
            preciosTool.classList.add('hidden');
            mapasTool.classList.add('hidden');
            tabMedidas.classList.remove('active');
            tabCollage.classList.add('active');
            tabPrecios.classList.remove('active');
            tabMapas.classList.remove('active');
        });

        tabPrecios.addEventListener('click', () => {
            medidasTool.classList.add('hidden');
            collageTool.classList.add('hidden');
            preciosTool.classList.remove('hidden');
            mapasTool.classList.add('hidden');
            tabMedidas.classList.remove('active');
            tabCollage.classList.remove('active');
            tabPrecios.classList.add('active');
            tabMapas.classList.remove('active');
        });

        tabMapas.addEventListener('click', () => {
            medidasTool.classList.add('hidden');
            collageTool.classList.add('hidden');
            preciosTool.classList.add('hidden');
            mapasTool.classList.remove('hidden');
            tabMedidas.classList.remove('active');
            tabCollage.classList.remove('active');
            tabPrecios.classList.remove('active');
            tabMapas.classList.add('active');
        });

        // --- LÓGICA DE MEDIDAS ---
        (() => {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const imageLoader = document.getElementById('image-loader');
            const downloadBtn = document.getElementById('download-btn');
            const resetBtn = document.getElementById('reset-btn');
            const canvasContainer = document.getElementById('canvas-container');
            const placeholderText = document.getElementById('placeholder-text');
            const colorPalette = document.getElementById('color-palette');
            const modal = document.getElementById('modal');
            const measurementInput = document.getElementById('measurement-input');
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const toolMeasureBtn = document.getElementById('tool-measure');
            const toolBrushBtn = document.getElementById('tool-brush');
            const measureControls = document.getElementById('measure-controls');
            const brushControls = document.getElementById('brush-controls');
            const brushColorPicker = document.getElementById('brush-color-picker');
            const brushSizeSlider = document.getElementById('brush-size-slider');
            const brushSizeValue = document.getElementById('brush-size-value');

            let image = null;
            let measurements = [];
            let brushStrokes = [];
            let currentPath = [];
            let isDrawing = false;
            let startX, startY, endX, endY;
            let measureColor = '#000000';
            let hoveredMeasurementIndex = -1;
            let currentTool = 'measure';
            let brushColor = '#FFFFFF';
            let brushSize = 20;
            
            const CANVAS_WIDTH = 1000;
            const CANVAS_HEIGHT = 1000;
            const TEXT_SIZE = 30;
            const LINE_WIDTH = 3;
            const CAP_LENGTH = 15;
            const DELETE_BUTTON_RADIUS = 15;

            function initMedidas() {
                setupMedidasEventListeners();
                clearCanvas();
            }

            function setupMedidasEventListeners() {
                imageLoader.addEventListener('change', handleImageUpload);
                canvasContainer.addEventListener('dragover', handleDragOver);
                canvasContainer.addEventListener('dragleave', handleDragLeave);
                canvasContainer.addEventListener('drop', handleDrop);
                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', handleMouseUp);
                canvas.addEventListener('mouseleave', handleMouseLeave);
                canvas.addEventListener('click', handleClick);
                downloadBtn.addEventListener('click', downloadImage);
                resetBtn.addEventListener('click', clearAll);
                colorPalette.addEventListener('click', selectMeasureColor);
                toolMeasureBtn.addEventListener('click', () => switchTool('measure'));
                toolBrushBtn.addEventListener('click', () => switchTool('brush'));
                brushColorPicker.addEventListener('input', (e) => { brushColor = e.target.value; updateCursor(); });
                brushSizeSlider.addEventListener('input', (e) => { brushSize = e.target.value; brushSizeValue.textContent = brushSize; updateCursor(); });
                submitBtn.addEventListener('click', submitMeasurement);
                cancelBtn.addEventListener('click', cancelMeasurement);
                measurementInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitMeasurement(); if (e.key === 'Escape') cancelMeasurement(); });
                window.addEventListener('resize', updateCursor);
            }
            
            function updateBrushCursor() {
                const rect = canvas.getBoundingClientRect();
                if (rect.width === 0) return;
                const scale = rect.width / CANVAS_WIDTH;
                const scaledSize = Math.max(parseInt(brushSize) * scale, 1);
                const cursorCanvas = document.createElement('canvas');
                const cursorCtx = cursorCanvas.getContext('2d');
                const canvasSize = scaledSize + 4;
                cursorCanvas.width = canvasSize;
                cursorCanvas.height = canvasSize;
                const center = canvasSize / 2;
                cursorCtx.beginPath();
                cursorCtx.arc(center, center, scaledSize / 2, 0, 2 * Math.PI);
                cursorCtx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                cursorCtx.lineWidth = 2.5;
                cursorCtx.stroke();
                cursorCtx.beginPath();
                cursorCtx.arc(center, center, scaledSize / 2, 0, 2 * Math.PI);
                cursorCtx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                cursorCtx.lineWidth = 1;
                cursorCtx.stroke();
                cursorCtx.beginPath();
                cursorCtx.arc(center, center, scaledSize / 2, 0, 2 * Math.PI);
                cursorCtx.fillStyle = brushColor;
                cursorCtx.fill();
                const dataURL = cursorCanvas.toDataURL();
                canvas.style.cursor = `url(${dataURL}) ${center} ${center}, crosshair`;
            }

            function switchTool(tool) {
                currentTool = tool;
                toolMeasureBtn.classList.toggle('active', tool === 'measure');
                toolBrushBtn.classList.toggle('active', tool !== 'measure');
                measureControls.style.display = tool === 'measure' ? 'block' : 'none';
                brushControls.style.display = tool !== 'measure' ? 'block' : 'none';
                updateCursor();
            }

            function updateCursor() {
                if (!image) { canvas.style.cursor = 'default'; return; }
                if (currentTool === 'measure') { canvas.style.cursor = hoveredMeasurementIndex !== -1 ? 'pointer' : 'crosshair'; } 
                else { updateBrushCursor(); }
            }
            
            function handleImageUpload(e) { const file = e.target.files[0]; if (file) loadImage(file); }
            function handleDragOver(e) { e.preventDefault(); e.stopPropagation(); canvasContainer.classList.add('drag-over'); }
            function handleDragLeave(e) { e.preventDefault(); e.stopPropagation(); canvasContainer.classList.remove('drag-over'); }
            function handleDrop(e) {
                e.preventDefault(); e.stopPropagation(); canvasContainer.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) loadImage(file);
            }

            function loadImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    image = new Image();
                    image.onload = () => { clearAll(); enableButtons(); redrawCanvas(); };
                    image.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            function enableButtons() {
                downloadBtn.disabled = false;
                resetBtn.disabled = false;
                placeholderText.style.display = 'none';
                updateCursor();
            }

            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                return { x: (e.clientX - rect.left) * (CANVAS_WIDTH / rect.width), y: (e.clientY - rect.top) * (CANVAS_HEIGHT / rect.height) };
            }

            function handleMouseDown(e) {
                if (!image) return;
                const pos = getMousePos(e);
                isDrawing = true;
                if (currentTool === 'measure') {
                    if (hoveredMeasurementIndex !== -1) { isDrawing = false; return; }
                    startX = pos.x;
                    startY = pos.y;
                } else { currentPath = [{ x: pos.x, y: pos.y }]; }
            }

            function handleMouseMove(e) {
                const pos = getMousePos(e);
                if (isDrawing) {
                    if (currentTool === 'measure') {
                        let currentX = pos.x; let currentY = pos.y;
                        if (e.shiftKey) {
                            const dx = Math.abs(currentX - startX); const dy = Math.abs(currentY - startY);
                            if (dx > dy) currentY = startY; else currentX = startX;
                        }
                        endX = currentX; endY = currentY;
                        redrawCanvas();
                        drawMeasurementLine({startX, startY, endX, endY, color: measureColor});
                    } else {
                        if (e.shiftKey && currentPath.length > 0) { currentPath = [currentPath[0], { x: pos.x, y: pos.y }]; } 
                        else { currentPath.push({ x: pos.x, y: pos.y }); }
                        redrawCanvas();
                    }
                } else if (currentTool === 'measure') {
                    let newHoverIndex = -1;
                    for (let i = measurements.length - 1; i >= 0; i--) {
                        const m = measurements[i];
                        const buttonPos = getDeleteButtonPosition(m);
                        if (Math.hypot(pos.x - buttonPos.x, pos.y - buttonPos.y) <= DELETE_BUTTON_RADIUS) { newHoverIndex = i; break; }
                        if (pointToLineSegmentDistance(pos.x, pos.y, m.startX, m.startY, m.endX, m.endY) < 10) { newHoverIndex = i; break; }
                    }
                    if (newHoverIndex !== hoveredMeasurementIndex) {
                        hoveredMeasurementIndex = newHoverIndex;
                        updateCursor();
                        redrawCanvas();
                    }
                }
            }

            function handleMouseUp() {
                if (!isDrawing) return;
                isDrawing = false;
                if (currentTool === 'measure') { if (startX !== endX || startY !== endY) showModal(); } 
                else { if (currentPath.length > 1) { brushStrokes.push({ points: currentPath, color: brushColor, size: brushSize }); } currentPath = []; }
            }
            
            function handleMouseLeave() {
                if (isDrawing) {
                    isDrawing = false;
                    if (currentTool === 'brush' && currentPath.length > 1) { brushStrokes.push({ points: currentPath, color: brushColor, size: brushSize }); }
                    currentPath = [];
                    redrawCanvas();
                }
                if(hoveredMeasurementIndex !== -1) { hoveredMeasurementIndex = -1; updateCursor(); redrawCanvas(); }
            }

            function handleClick(e) {
                if (currentTool === 'measure' && hoveredMeasurementIndex !== -1) {
                    const pos = getMousePos(e);
                    const m = measurements[hoveredMeasurementIndex];
                    const buttonPos = getDeleteButtonPosition(m);
                    if (Math.hypot(pos.x - buttonPos.x, pos.y - buttonPos.y) <= DELETE_BUTTON_RADIUS) {
                        measurements.splice(hoveredMeasurementIndex, 1);
                        hoveredMeasurementIndex = -1;
                        updateCursor();
                        redrawCanvas();
                    }
                }
            }

            function pointToLineSegmentDistance(px, py, x1, y1, x2, y2) {
                const l2 = (x2 - x1) ** 2 + (y2 - y1) ** 2;
                if (l2 === 0) return Math.hypot(px - x1, py - y1);
                let t = ((px - x1) * (x2 - x1) + (py - y1) * (y2 - y1)) / l2;
                t = Math.max(0, Math.min(1, t));
                const closestX = x1 + t * (x2 - x1); const closestY = y1 + t * (y2 - y1);
                return Math.hypot(px - closestX, py - closestY);
            }

            function showModal() { modal.style.display = 'flex'; measurementInput.value = ''; measurementInput.focus(); }
            function hideModal() { modal.style.display = 'none'; }
            function submitMeasurement() {
                const text = measurementInput.value.trim();
                if (text) measurements.push({ startX, startY, endX, endY, color: measureColor, text });
                hideModal();
                redrawCanvas();
            }
            function cancelMeasurement() { hideModal(); redrawCanvas(); }

            function clearCanvas() {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                if (!image) placeholderText.style.display = 'flex';
                updateCursor();
            }
            
            function redrawCanvas() {
                clearCanvas();
                if (image) {
                    const hRatio = CANVAS_WIDTH / image.width; const vRatio = CANVAS_HEIGHT / image.height;
                    const ratio = Math.min(hRatio, vRatio);
                    const centerShiftX = (CANVAS_WIDTH - image.width * ratio) / 2;
                    const centerShiftY = (CANVAS_HEIGHT - image.height * ratio) / 2;
                    ctx.drawImage(image, 0, 0, image.width, image.height, centerShiftX, centerShiftY, image.width * ratio, image.height * ratio);
                }
                brushStrokes.forEach(drawBrushStroke);
                if (isDrawing && currentTool === 'brush' && currentPath.length > 0) { drawBrushStroke({ points: currentPath, color: brushColor, size: brushSize }); }
                measurements.forEach((m, index) => drawMeasurementLine(m, index));
            }
            
            function drawBrushStroke(stroke) {
                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                for (let i = 1; i < stroke.points.length; i++) { ctx.lineTo(stroke.points[i].x, stroke.points[i].y); }
                ctx.stroke();
            }

            function getDeleteButtonPosition(m) {
                 const angle = Math.atan2(m.endY - m.startY, m.endX - m.startX);
                 const perpAngle = angle + Math.PI / 2;
                 return { x: m.endX + (CAP_LENGTH + 5) * Math.cos(perpAngle), y: m.endY + (CAP_LENGTH + 5) * Math.sin(perpAngle) };
            }

            function drawMeasurementLine(m, index) {
                const { startX, startY, endX, endY, color, text = '' } = m;
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = (index === hoveredMeasurementIndex && currentTool === 'measure') ? LINE_WIDTH + 2 : LINE_WIDTH;
                ctx.font = `bold ${TEXT_SIZE}px Inter`;
                const angle = Math.atan2(endY - startY, endX - startX);
                const perpAngle = angle + Math.PI / 2;
                const cap1_x1 = startX + CAP_LENGTH * Math.cos(perpAngle); const cap1_y1 = startY + CAP_LENGTH * Math.sin(perpAngle);
                const cap1_x2 = startX - CAP_LENGTH * Math.cos(perpAngle); const cap1_y2 = startY - CAP_LENGTH * Math.sin(perpAngle);
                const cap2_x1 = endX + CAP_LENGTH * Math.cos(perpAngle); const cap2_y1 = endY + CAP_LENGTH * Math.sin(perpAngle);
                const cap2_x2 = endX - CAP_LENGTH * Math.cos(perpAngle); const cap2_y2 = endY - CAP_LENGTH * Math.sin(perpAngle);
                ctx.beginPath();
                if (text) {
                    const textMetrics = ctx.measureText(text);
                    const textWidth = textMetrics.width + 10;
                    const lineLength = Math.hypot(endX - startX, endY - startY);
                    const segmentLength = (lineLength - textWidth) / 2;
                    if (segmentLength > 0) {
                        const gapStartX = startX + segmentLength * Math.cos(angle); const gapStartY = startY + segmentLength * Math.sin(angle);
                        const gapEndX = endX - segmentLength * Math.cos(angle); const gapEndY = endY - segmentLength * Math.sin(angle);
                        ctx.moveTo(startX, startY); ctx.lineTo(gapStartX, gapStartY);
                        ctx.moveTo(gapEndX, gapEndY); ctx.lineTo(endX, endY);
                    }
                } else { ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); }
                ctx.moveTo(cap1_x1, cap1_y1); ctx.lineTo(cap1_x2, cap1_y2);
                ctx.moveTo(cap2_x1, cap2_y1); ctx.lineTo(cap2_x2, cap2_y2);
                ctx.stroke();
                if (text) {
                    const midX = (startX + endX) / 2; const midY = (startY + endY) / 2;
                    ctx.save();
                    ctx.translate(midX, midY);
                    ctx.rotate(angle);
                    if (angle > Math.PI / 2 || angle < -Math.PI / 2) ctx.rotate(Math.PI);
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(text, 0, 0); 
                    ctx.restore();
                }
                if (index === hoveredMeasurementIndex && currentTool === 'measure') {
                    const buttonPos = getDeleteButtonPosition(m);
                    ctx.beginPath();
                    ctx.arc(buttonPos.x, buttonPos.y, DELETE_BUTTON_RADIUS, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.9)';
                    ctx.fill();
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(buttonPos.x - 6, buttonPos.y - 6); ctx.lineTo(buttonPos.x + 6, buttonPos.y + 6);
                    ctx.moveTo(buttonPos.x + 6, buttonPos.y - 6); ctx.lineTo(buttonPos.x - 6, buttonPos.y + 6);
                    ctx.stroke();
                }
            }

            function selectMeasureColor(e) {
                if (e.target.classList.contains('color-swatch')) {
                    colorPalette.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('selected'));
                    e.target.classList.add('selected');
                    measureColor = e.target.dataset.color;
                }
            }

            function downloadImage() {
                hoveredMeasurementIndex = -1;
                redrawCanvas();
                const link = document.createElement('a');
                link.download = 'arelyshop-medidas.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
            
            function clearAll() {
                measurements = [];
                brushStrokes = [];
                hoveredMeasurementIndex = -1;
                redrawCanvas();
            }

            initMedidas();
        })();

        // --- LÓGICA DE COLLAGE ---
        (() => {
            const collageImageLoader = document.getElementById('collage-image-loader');
            const loadMultipleCollageBtn = document.getElementById('load-multiple-collage-btn');
            const collageMultipleLoader = document.getElementById('collage-multiple-loader');
            const collageCells = document.querySelectorAll('.collage-cell');
            const downloadCollageBtn = document.getElementById('download-collage-btn');
            const clearCollageBtn = document.getElementById('clear-collage-btn');
            let activeCell = null;
            let draggedItem = null;

            function setCellImage(cell, file) {
                 const reader = new FileReader();
                 reader.onload = (event) => {
                     cell.style.backgroundImage = `url('${event.target.result}')`;
                     cell.classList.add('has-image');
                 };
                 reader.readAsDataURL(file);
            }

            function clearCell(cell) {
                cell.style.backgroundImage = '';
                cell.classList.remove('has-image');
            }

            collageCells.forEach(cell => {
                const deleteBtn = cell.querySelector('.delete-cell-btn');

                cell.addEventListener('click', () => {
                    activeCell = cell;
                    collageImageLoader.click();
                });

                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clearCell(cell);
                });

                cell.addEventListener('dragstart', () => {
                    draggedItem = cell;
                    setTimeout(() => cell.classList.add('dragging'), 0);
                });

                cell.addEventListener('dragend', () => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });

                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    cell.classList.add('drag-over-target');
                });

                cell.addEventListener('dragleave', () => {
                    cell.classList.remove('drag-over-target');
                });

                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cell.classList.remove('drag-over-target');
                    
                    if (e.dataTransfer.files.length > 0) {
                        const file = e.dataTransfer.files[0];
                        if (file.type.startsWith('image/')) {
                            setCellImage(cell, file);
                        }
                    } 
                    else if (draggedItem && draggedItem !== cell) {
                        const sourceBg = draggedItem.style.backgroundImage;
                        const targetBg = cell.style.backgroundImage;
                        draggedItem.style.backgroundImage = targetBg;
                        cell.style.backgroundImage = sourceBg;
                        
                        const sourceHasImage = draggedItem.classList.contains('has-image');
                        const targetHasImage = cell.classList.contains('has-image');
                        draggedItem.classList.toggle('has-image', targetHasImage);
                        cell.classList.toggle('has-image', sourceHasImage);
                    }
                });
            });

            collageImageLoader.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && activeCell) {
                    setCellImage(activeCell, file);
                }
                e.target.value = '';
            });

            loadMultipleCollageBtn.addEventListener('click', () => {
                collageMultipleLoader.click();
            });

            collageMultipleLoader.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files.length) return;

                const emptyCells = Array.from(collageCells).filter(cell => !cell.classList.contains('has-image'));
                
                for (let i = 0; i < Math.min(files.length, emptyCells.length); i++) {
                    setCellImage(emptyCells[i], files[i]);
                }

                e.target.value = '';
            });


            clearCollageBtn.addEventListener('click', () => {
                collageCells.forEach(cell => clearCell(cell));
            });

            downloadCollageBtn.addEventListener('click', () => {
                const collageCanvas = document.createElement('canvas');
                const collageCtx = collageCanvas.getContext('2d');
                
                const activeCells = Array.from(document.querySelectorAll('.collage-cell.has-image'));
                const imageCount = activeCells.length;

                let finalWidth, finalHeight, segmentWidth, segmentHeight;
                let isTwoImageHorizontalLayout = false;

                if (imageCount === 2) {
                    finalWidth = 1200;
                    finalHeight = 600;
                    segmentWidth = 600;
                    segmentHeight = 600;
                    isTwoImageHorizontalLayout = true;
                } else {
                    finalWidth = 1200;
                    finalHeight = 1200;
                    segmentWidth = 600;
                    segmentHeight = 600;
                }

                collageCanvas.width = finalWidth;
                collageCanvas.height = finalHeight;
                collageCtx.fillStyle = '#FFFFFF';
                collageCtx.fillRect(0, 0, finalWidth, finalHeight);

                const imagePromises = [];

                const drawImageToCanvas = (img, x, y, width, height) => {
                    const hRatio = width / img.width;
                    const vRatio = height / img.height;
                    const ratio = Math.min(hRatio, vRatio);
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;
                    const offsetX = (width - newWidth) / 2;
                    const offsetY = (height - newHeight) / 2;
                    collageCtx.drawImage(img, x + offsetX, y + offsetY, newWidth, newHeight);
                };

                if (isTwoImageHorizontalLayout) {
                    activeCells.forEach((cell, index) => {
                        const promise = new Promise((resolve) => {
                            const img = new Image();
                            const bgImage = cell.style.backgroundImage;
                            img.src = bgImage.substring(5, bgImage.length - 2);
                            img.onload = () => {
                                const x = index * segmentWidth;
                                const y = 0;
                                drawImageToCanvas(img, x, y, segmentWidth, segmentHeight);
                                resolve();
                            };
                            img.onerror = () => resolve();
                        });
                        imagePromises.push(promise);
                    });
                } else {
                    collageCells.forEach((cell, index) => {
                        if (cell.classList.contains('has-image')) {
                            const promise = new Promise((resolve) => {
                                const img = new Image();
                                const bgImage = cell.style.backgroundImage;
                                img.src = bgImage.substring(5, bgImage.length - 2);
                                img.onload = () => {
                                    const x = (index % 2) * segmentWidth;
                                    const y = Math.floor(index / 2) * segmentHeight;
                                    drawImageToCanvas(img, x, y, segmentWidth, segmentHeight);
                                    resolve();
                                };
                                img.onerror = () => resolve();
                            });
                            imagePromises.push(promise);
                        }
                    });
                }

                Promise.all(imagePromises).then(() => {
                    const link = document.createElement('a');
                    link.download = 'arelyshop-collage.png';
                    link.href = collageCanvas.toDataURL('image/png');
                    link.click();
                });
            });
        })();

        // --- LÓGICA DE PRECIOS ---
        (() => {
            const priceInput = document.getElementById('price-input');
            const watermarkInput = document.getElementById('watermark-input');
            const downloadBtn = document.getElementById('download-price-btn');
            const clearBtn = document.getElementById('clear-price-btn');
            const placeholder = document.getElementById('precios-placeholder-text');
            const previewsContainer = document.getElementById('precios-previews-container');
            const imageLoader = document.getElementById('precios-image-loader');

            let priceImages = []; // Almacenará {file, image, canvas, ctx}

            const faBrandsFont = new FontFace('FontAwesomeBrands', 'url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/webfonts/fa-brands-400.woff2)');
            const faSolidFont = new FontFace('FontAwesomeSolid', 'url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/webfonts/fa-solid-900.woff2)');
            
            Promise.all([faBrandsFont.load(), faSolidFont.load()]).then((loadedFonts) => {
                document.fonts.add(loadedFonts[0]);
                document.fonts.add(loadedFonts[1]);
                drawAll();
            });

            function drawSingle(imgData) {
                const { image, canvas, ctx } = imgData;
                if (!image || !image.src) return;

                const hRatio = canvas.width / image.width;
                const vRatio = canvas.height / image.height;
                const ratio = Math.min(hRatio, vRatio);
                const centerShiftX = (canvas.width - image.width * ratio) / 2;
                const centerShiftY = (canvas.height - image.height * ratio) / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, 0, 0, image.width, image.height, centerShiftX, centerShiftY, image.width * ratio, image.height * ratio);

                // --- DIBUJAR MARCAS DE AGUA ---
                ctx.save();
                const watermarkText = watermarkInput.value || '';
                
                if (watermarkText) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
                    ctx.textBaseline = 'middle';
                    ctx.textAlign = 'center';
                    
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(-Math.PI / 4);

                    ctx.font = 'bold 80px Inter';
                    ctx.fillText(watermarkText, 0, 0);
                }
                ctx.restore();

                // --- DIBUJAR PRECIO CENTRADO ---
                const priceText = `Bs. ${priceInput.value || '0'}`;
                const priceFontSize = 60;
                const tagIcon = '\uf02b';
                
                ctx.font = `900 ${priceFontSize}px FontAwesomeSolid`;
                const tagIconWidth = ctx.measureText(tagIcon).width;
                ctx.font = `bold ${priceFontSize}px Inter`;
                const priceTextWidth = ctx.measureText(priceText).width;
                const totalWidth = tagIconWidth + 15 + priceTextWidth;
                const boxPadding = 30;
                const boxWidth = totalWidth + boxPadding * 2;
                const boxHeight = priceFontSize + 30;

                const boxX = (canvas.width - boxWidth) / 2;
                const boxY = canvas.height - boxHeight - 20;

                ctx.fillStyle = '#ef4444';
                ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

                ctx.fillStyle = 'white';
                ctx.textBaseline = 'middle';
                
                ctx.font = `900 ${priceFontSize}px FontAwesomeSolid`;
                ctx.fillText(tagIcon, boxX + boxPadding, boxY + boxHeight / 2);
                
                ctx.font = `bold ${priceFontSize}px Inter`;
                ctx.fillText(priceText, boxX + boxPadding + tagIconWidth + 15, boxY + boxHeight / 2);
            }

            function drawAll() {
                if (priceImages.length === 0) {
                    previewsContainer.classList.add('is-placeholder');
                    downloadBtn.disabled = true;
                    clearBtn.disabled = true;
                } else {
                    previewsContainer.classList.remove('is-placeholder');
                    downloadBtn.disabled = false;
                    clearBtn.disabled = false;
                }
                priceImages.forEach(drawSingle);
            }

            function handleFiles(files) {
                previewsContainer.innerHTML = '';
                priceImages = [];
                if (files.length === 0) {
                    drawAll();
                    return;
                }

                for (const file of files) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1000;
                    canvas.height = 1000;
                    const ctx = canvas.getContext('2d');

                    const wrapper = document.createElement('div');
                    wrapper.className = 'price-preview-wrapper';
                    
                    const downloadSingleBtn = document.createElement('button');
                    downloadSingleBtn.className = 'download-single-price-btn';
                    downloadSingleBtn.innerHTML = '<i class="fa-solid fa-download"></i>';
                    
                    wrapper.appendChild(canvas);
                    wrapper.appendChild(downloadSingleBtn);
                    previewsContainer.appendChild(wrapper);

                    const image = new Image();
                    const imgData = { file, image, canvas, ctx };
                    priceImages.push(imgData);

                    downloadSingleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const link = document.createElement('a');
                        const originalName = imgData.file.name.replace(/\.[^/.]+$/, "");
                        link.download = `${originalName}-precio.png`;
                        link.href = imgData.canvas.toDataURL('image/png');
                        link.click();
                    });

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        image.onload = () => drawSingle(imgData);
                        image.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
                drawAll();
            }

            function clearAll() {
                priceImages = [];
                previewsContainer.innerHTML = `
                    <div id="precios-placeholder-text" class="w-full text-center text-slate-400 p-4 flex flex-col items-center gap-2">
                            <p class="text-lg font-semibold pointer-events-none">Sube una o más imágenes para empezar</p>
                             <span class="text-sm pointer-events-none">o</span>
                            <label for="precios-image-loader" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">
                                Cargar Foto(s)
                            </label>
                    </div>`;
                priceInput.value = '';
                watermarkInput.value = 'ArelyShop';
                imageLoader.value = '';
                drawAll();
            }

            imageLoader.addEventListener('change', (e) => handleFiles(e.target.files));
            priceInput.addEventListener('input', drawAll);
            watermarkInput.addEventListener('input', drawAll);
            clearBtn.addEventListener('click', clearAll);

            downloadBtn.addEventListener('click', () => {
                priceImages.forEach((imgData) => {
                    const link = document.createElement('a');
                    const originalName = imgData.file.name.replace(/\.[^/.]+$/, "");
                    link.download = `${originalName}-precio.png`;
                    link.href = imgData.canvas.toDataURL('image/png');
                    link.click();
                });
            });

            drawAll();
        })();

        // --- LÓGICA DE MAPAS ---
        (() => {
            const searchInput = document.getElementById('map-searchInput');
            const searchBtn = document.getElementById('map-searchBtn');
            const searchBtnText = searchBtn.querySelector('.search-text');
            const searchLoader = searchBtn.querySelector('.loader');
            const getDirectionBtn = document.getElementById('map-getDirectionBtn');
            const googleMapsUrlInput = document.getElementById('googleMapsUrl');
            const coordsInput = document.getElementById('coordsInput');
            const resultsDiv = document.getElementById('map-results');
            const errorMessageDiv = document.getElementById('map-error-message');
            const errorText = document.getElementById('map-error-text');
            const notificationDiv = document.getElementById('notification');
            const tabUrl = document.getElementById('map-tab-url');
            const tabCoords = document.getElementById('map-tab-coords');
            const contentUrl = document.getElementById('map-content-url');
            const contentCoords = document.getElementById('map-content-coords');
            const pasteUrlBtn = document.getElementById('map-paste-url');
            const pasteCoordsBtn = document.getElementById('map-paste-coords');

            let activeTab = 'url';

            searchBtn.addEventListener('click', handleLocationSearch);
            searchInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleLocationSearch());
            getDirectionBtn.addEventListener('click', handleTabConversion);
            googleMapsUrlInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleTabConversion());
            coordsInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleTabConversion());
            
            googleMapsUrlInput.addEventListener('input', clearResults);
            coordsInput.addEventListener('input', clearResults);
            searchInput.addEventListener('input', clearResults);

            tabUrl.addEventListener('click', () => switchTab('url'));
            tabCoords.addEventListener('click', () => switchTab('coords'));
            
            pasteUrlBtn.addEventListener('click', () => pasteFromClipboard(googleMapsUrlInput));
            pasteCoordsBtn.addEventListener('click', () => pasteFromClipboard(coordsInput));

            async function pasteFromClipboard(targetInput) {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        targetInput.value = text;
                        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } catch (err) {
                    console.error('Failed to read clipboard contents: ', err);
                    showError('paste-failed');
                }
            }

            async function handleLocationSearch() {
                const query = searchInput.value.trim();
                if (!query) return;

                clearResults();
                toggleSearchLoading(true);

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        generateLinks(lat, lon);
                    } else {
                        showError('no-search-results');
                    }
                } catch (error) {
                    console.error("Search failed:", error);
                    showError('search-failed');
                } finally {
                    toggleSearchLoading(false);
                }
            }

            function switchTab(tabName) {
                activeTab = tabName;
                clearAllInputs();
                if (tabName === 'url') {
                    tabUrl.classList.add('active');
                    tabCoords.classList.remove('active');
                    contentUrl.classList.add('active');
                    contentCoords.classList.remove('active');
                } else {
                    tabUrl.classList.remove('active');
                    tabCoords.classList.add('active');
                    contentUrl.classList.remove('active');
                    contentCoords.classList.add('active');
                }
            }

            function handleTabConversion() {
                let coords = null;
                if (activeTab === 'url') {
                    const url = googleMapsUrlInput.value.trim();
                    if (!url) { clearResults(); return; }
                    if (url.startsWith('https://maps.app.goo.gl')) {
                        showError('short-url', url);
                        return;
                    }
                    coords = extractCoordinatesFromUrl(url);
                    if (!coords) showError('invalid-url');

                } else { // activeTab === 'coords'
                    const coordString = coordsInput.value.trim();
                    if (!coordString) { clearResults(); return; }
                    coords = parseCoordinates(coordString);
                    if (!coords) showError('invalid-coords');
                }

                if (coords) {
                    hideError();
                    generateLinks(coords.lat, coords.lon);
                }
            }

            function parseCoordinates(str) {
                let match = str.match(/^(-?\d+\.?\d*)[, ]+(-?\d+\.?\d*)$/);
                if (match) {
                    return { lat: parseFloat(match[1]), lon: parseFloat(match[2]) };
                }
                const dmsRegex = /(\d+)[°\s]+(\d+)[',\s]+([\d.]+)"?\s*([NS])[, ]+(\d+)[°\s]+(\d+)[',\s]+([\d.]+)"?\s*([WE])/i;
                match = str.match(dmsRegex);
                if (match) {
                    const [, latD, latM, latS, latDir, lonD, lonM, lonS, lonDir] = match;
                    let lat = parseFloat(latD) + (parseFloat(latM) / 60) + (parseFloat(latS) / 3600);
                    if (latDir.toUpperCase() === 'S') lat = -lat;
                    let lon = parseFloat(lonD) + (parseFloat(lonM) / 60) + (parseFloat(lonS) / 3600);
                    if (lonDir.toUpperCase() === 'W') lon = -lon;
                    return { lat, lon };
                }
                return null;
            }

            function extractCoordinatesFromUrl(url) {
                const patterns = [ /@(-?\d+\.\d+),(-?\d+\.\d+)/, /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/, /ll=(-?\d+\.\d+),(-?\d+\.\d+)/, /search\/(-?\d+\.\d+),(-?\d+\.\d+)/, /query=(-?\d+\.\d*),(-?\d+\.\d*)/ ];
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match && match.length >= 3) {
                        return { lat: parseFloat(match[1]), lon: parseFloat(match[2]) };
                    }
                }
                return null;
            }

            function generateLinks(lat, lon) {
                clearResults();
                const links = [
                    { name: 'Waze', url: `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`, color: 'bg-indigo-500 hover:bg-indigo-600', iconColor: 'text-indigo-500' },
                    { name: 'Apple Maps', url: `http://maps.apple.com/?ll=${lat},${lon}&q=Ubicación`, color: 'bg-sky-500 hover:bg-sky-600', iconColor: 'text-sky-500' },
                    { name: 'OpenStreetMap', url: `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=16`, color: 'bg-emerald-500 hover:bg-emerald-600', iconColor: 'text-emerald-500' },
                    { name: 'Geo Link (Móvil)', url: `geo:${lat},${lon}`, color: 'bg-gray-500 hover:bg-gray-600', iconColor: 'text-gray-500' }
                ];
                const fullIcons = {
                    'Waze': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14.61 4.416c-1.936-.55-3.953-.42-5.783.33a.75.75 0 00-.33 1.05c.3.56.96.78 1.52.48 1.3-.36 2.68-.42 3.99-.12a.75.75 0 00.6-.94zm-10.22 6.54c.24-1.8 1.14-3.45 2.5-4.74a.75.75 0 00-1.05-1.05c-1.56 1.48-2.61 3.42-2.91 5.61a.75.75 0 00.75.87c.4-.03.72-.36.69-.75l-.03-.2a.75.75 0 00-.03-.2zm7.62 9.294c1.82.51 3.73.48 5.49-.09a.75.75 0 00.45-1.11c-.39-.52-1.08-.66-1.62-.33-1.29.33-2.61.39-3.87.12a.75.75 0 00-.69.99c.06.33.27.6.54.42zm-1.6-6.264a3 3 0 116 0 3 3 0 01-6 0zm-1.5-3a4.5 4.5 0 109 0 4.5 4.5 0 00-9 0z"></path></svg>`,
                    'Apple Maps': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12.01 2.011c-4.29 0-7.93 3.3-8.01 7.59v.01c0 4.3 3.71 7.83 8 7.83s8-3.54 8-7.83v-.01c-.07-4.29-3.71-7.59-7.99-7.59zm-4.3 7.59c0-2.37 1.93-4.3 4.3-4.3s4.3 1.93 4.3 4.3c0 2.36-1.93 4.3-4.3 4.3s-4.3-1.93-4.3-4.3zm10.3 5.43l-2.11 2.12c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-1.42-1.42-1.42 1.42c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-2.11-2.12c-1.31.76-2.29 2.04-2.29 3.54v.01c0 .06 0 .12.01.17h16.98c0-.06.01-.11.01-.17v-.01c0-1.5-1-2.78-2.29-3.54z"></path></svg>`,
                    'OpenStreetMap': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-4.418 0-8 3.582-8 8 0 4.419 8 14 8 14s8-9.581 8-14c0-4.418-3.582-8-8-8zm0 11.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z"></path></svg>`,
                    'Geo Link (Móvil)': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>`
                };

                const resultsTitle = document.createElement('h3');
                resultsTitle.className = "text-lg font-semibold text-gray-700";
                resultsTitle.textContent = "Abrir con:";
                resultsDiv.appendChild(resultsTitle);

                links.forEach(link => {
                    const rowContainer = document.createElement('div');
                    rowContainer.className = 'flex items-center justify-between p-2 rounded-lg bg-gray-50';
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'flex items-center gap-3';
                    const iconSpan = document.createElement('span');
                    iconSpan.innerHTML = fullIcons[link.name];
                    iconSpan.className = `flex items-center justify-center w-8 h-8 ${link.iconColor}`;
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = link.name;
                    nameSpan.className = 'font-medium text-gray-700';
                    nameContainer.appendChild(iconSpan);
                    nameContainer.appendChild(nameSpan);
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'flex items-center gap-2';
                    const goButton = document.createElement('a');
                    goButton.href = link.url;
                    if (!link.url.startsWith('intent:')) { goButton.target = '_blank'; }
                    goButton.rel = 'noopener noreferrer';
                    goButton.className = 'px-4 py-1.5 text-sm font-semibold text-white rounded-md shadow-sm transition-colors duration-200 ' + link.color;
                    goButton.textContent = 'Ir';
                    const copyButton = document.createElement('button');
                    copyButton.title = 'Copiar enlace';
                    copyButton.className = 'p-1.5 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors';
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                    copyButton.onclick = (e) => { e.preventDefault(); copyToClipboard(link.url); };
                    buttonsContainer.appendChild(goButton);
                    buttonsContainer.appendChild(copyButton);
                    rowContainer.appendChild(nameContainer);
                    rowContainer.appendChild(buttonsContainer);
                    resultsDiv.appendChild(rowContainer);
                });
            }
            
            function copyToClipboard(text) {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed'; ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    showNotification();
                } catch (err) { console.error('No se pudo copiar el texto: ', err); }
                document.body.removeChild(ta);
            }

            function showNotification() {
                notificationDiv.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => {
                    notificationDiv.classList.add('opacity-0', 'translate-y-10');
                }, 2000);
            }

            function clearAllInputs() {
                googleMapsUrlInput.value = '';
                coordsInput.value = '';
                searchInput.value = '';
                clearResults();
            }
            
            function clearResults() {
                resultsDiv.innerHTML = '';
                hideError();
            }

            function toggleSearchLoading(isLoading) {
                if (isLoading) {
                    searchBtnText.classList.add('hidden');
                    searchLoader.classList.remove('hidden');
                    searchBtn.disabled = true;
                } else {
                    searchBtnText.classList.remove('hidden');
                    searchLoader.classList.add('hidden');
                    searchBtn.disabled = false;
                }
            }

            function showError(type, data = '') {
                resultsDiv.innerHTML = '';
                let msg = '';
                switch (type) {
                    case 'short-url':
                        msg = `<strong>¡Enlace corto detectado!</strong> No se puede procesar directamente.<br><br><strong>Solución:</strong><br>1. <a href="${data}" target="_blank" rel="noopener noreferrer" class="font-bold underline text-blue-500">Haz clic aquí para abrirlo</a>.<br>2. Copia la nueva URL (larga) de tu navegador.<br>3. Pégala aquí y convierte de nuevo.`;
                        break;
                    case 'invalid-url':
                        msg = '<strong>¡URL no válida!</strong> No pudimos encontrar coordenadas. Asegúrate de que sea un enlace de Google Maps. Si estás pegando coordenadas (ej: 17°S 63°W), por favor usa la pestaña "Desde Coordenadas".';
                        break;
                    case 'invalid-coords':
                        msg = '<strong>¡Coordenadas no válidas!</strong> Usa un formato como "40.71, -74.00" o "40°42\'46\\"N 74°00\'21\\"W".';
                        break;
                    case 'no-search-results':
                        msg = '<strong>No se encontraron resultados.</strong> Por favor, intenta con una búsqueda más específica.';
                        break;
                    case 'search-failed':
                        msg = '<strong>La búsqueda falló.</strong> Por favor, revisa tu conexión a internet e inténtalo de nuevo.';
                        break;
                    case 'paste-failed':
                        msg = '<strong>No se pudo pegar.</strong> Revisa los permisos del portapapeles de tu navegador o pégalo manually.';
                        break;
                }
                errorText.innerHTML = msg;
                errorMessageDiv.classList.remove('hidden');
            }

            function hideError() {
                errorMessageDiv.classList.add('hidden');
            }
        })();
    });
    </script>
</body>
</html>
